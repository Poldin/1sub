---
title: Vendor Integration Guide
description: How to integrate your tool with 1sub for secure, revocable access control
---

# Vendor Integration Guide

This guide explains how to integrate your SaaS tool with 1sub using the **Authorization Code Flow** - the only supported integration method.

<Note>
For a quick implementation guide with code examples, see the [Quickstart Guide](/docs/quickstart).
</Note>

## How It Works

The integration uses an **authorization code flow** similar to OAuth:

1. User clicks "Launch Tool" on 1sub after purchasing a subscription
2. User is redirected to your callback URL with a single-use authorization code
3. Your server exchanges the code for a verification token and user entitlements
4. You create your own session and store the verification token
5. Every 5 minutes, you verify the token to check if access is still valid

## Prerequisites

Before you start, make sure you have:
- Your **API Key** from the 1sub vendor dashboard (format: `sk-tool-xxxxx`)
- A **redirect/callback URL** configured in your vendor dashboard
- HTTPS-enabled server to handle callbacks

## Quick Start (3 Steps)

### Step 1: Configure Your Callback URL

In your 1sub vendor dashboard, set your callback URL:

```
https://yourapp.com/auth/1sub/callback
```

This is where users will be redirected after clicking "Launch Tool".

### Step 2: Handle the Callback

When a user clicks "Launch Tool", they'll be redirected to your callback with a `code` parameter:

```
https://yourapp.com/auth/1sub/callback?code=ac_xxx&state=csrf_token
```

### Step 3: Exchange Code for Token

Exchange the authorization code for a verification token:

```typescript
// /auth/1sub/callback handler (Express example)
import axios from 'axios';

app.get('/auth/1sub/callback', async (req, res) => {
  const { code, state } = req.query;

  // Optional: Validate CSRF state
  if (state && state !== req.session.onesub_state) {
    return res.status(403).send('Invalid state');
  }

  try {
    // Exchange code for verification token
    const response = await axios.post(
      'https://1sub.io/api/v1/authorize/exchange',
      {
        code: code as string,
        redirectUri: 'https://yourapp.com/auth/1sub/callback',
      },
      {
        headers: {
          'Authorization': `Bearer ${process.env.ONESUB_API_KEY}`,
          'Content-Type': 'application/json',
        },
      }
    );

    const result = response.data;

    if (!result.valid) {
      return res.redirect('/error?reason=authorization_failed');
    }

    // Create YOUR session with the verification token
    req.session.user = {
      onesubUserId: result.onesubUserId,
      verificationToken: result.verificationToken,
      entitlements: result.entitlements,
      lastVerified: Date.now(),
    };

    res.redirect('/dashboard');
  } catch (error) {
    console.error('Authorization failed:', error);
    res.redirect('/error?reason=authorization_failed');
  }
});
```

## Exchange Response

When you successfully exchange the authorization code, you'll receive:

```json
{
  "valid": true,
  "grantId": "uuid",
  "onesubUserId": "uuid",
  "entitlements": {
    "planId": "monthly",
    "creditsRemaining": 500,
    "features": ["pro", "api_access"],
    "limits": { "api_calls_per_day": 10000 }
  },
  "verificationToken": "vt_xxx",
  "expiresAt": 1703000400
}
```

**Important fields:**
- `onesubUserId` - Unique identifier for the user on 1sub (store this!)
- `verificationToken` - Token for periodic verification (store this securely!)
- `entitlements` - User's subscription details, credits, and features
- `expiresAt` - Unix timestamp when the token expires (typically 24 hours)

## Periodic Verification (Required)

You **must** verify entitlements every 5 minutes to:
- Enforce revoked access within 5 minutes
- Get up-to-date entitlement information
- Receive new rolling tokens (prevents replay attacks)

```typescript
// Middleware to check verification
async function requireEntitlement(req, res, next) {
  const session = req.session.user;
  if (!session) {
    return res.redirect('/auth/1sub');
  }

  // Check if verification is needed (every 5 minutes)
  const fiveMinutes = 5 * 60 * 1000;
  if (Date.now() - session.lastVerified > fiveMinutes) {
    try {
      const response = await axios.post(
        'https://1sub.io/api/v1/verify',
        {
          verificationToken: session.verificationToken,
        },
        {
          headers: {
            'Authorization': `Bearer ${process.env.ONESUB_API_KEY}`,
            'Content-Type': 'application/json',
          },
        }
      );

      const result = response.data;

      if (!result.valid) {
        // Access revoked - terminate session
        req.session.destroy();
        return res.redirect('/auth/1sub?reason=access_revoked');
      }

      // Update session with new token (tokens roll!)
      session.verificationToken = result.verificationToken;
      session.entitlements = result.entitlements;
      session.lastVerified = Date.now();
    } catch (error) {
      console.error('Verification failed:', error);
      req.session.destroy();
      return res.redirect('/auth/1sub?reason=verification_failed');
    }
  }

  next();
}

// Use on protected routes
app.use('/dashboard', requireEntitlement);
app.use('/api', requireEntitlement);
```

## Webhooks (Recommended)

Webhooks allow immediate access revocation instead of waiting up to 5 minutes for the next verification cycle.

```typescript
import crypto from 'crypto';
import express from 'express';

app.post(
  '/webhooks/1sub',
  express.raw({ type: 'application/json' }),
  async (req, res) => {
    const signature = req.headers['1sub-signature'] as string;
    const payload = req.body.toString();

    // Verify webhook signature
    if (!verifyWebhookSignature(payload, signature, process.env.ONESUB_WEBHOOK_SECRET!)) {
      return res.status(401).send('Invalid signature');
    }

    // Acknowledge immediately
    res.status(200).send('OK');

    // Handle event
    const event = JSON.parse(payload);

    switch (event.type) {
      case 'subscription.activated':
        // User's subscription was activated
        console.log('Subscription activated:', event.data.oneSubUserId);
        break;

      case 'subscription.canceled':
        // Subscription cancelled - invalidate sessions
        await sessionStore.invalidate(event.data.oneSubUserId);
        break;

      case 'subscription.updated':
        // Subscription plan/status changed
        await sessionStore.markForRevalidation(event.data.oneSubUserId);
        break;
    }
  }
);

function verifyWebhookSignature(
  payload: string,
  signature: string,
  secret: string
): boolean {
  const parts = signature.split(',');
  const timestamp = parts.find(p => p.startsWith('t='))?.split('=')[1];
  const sig = parts.find(p => p.startsWith('v1='))?.split('=')[1];

  if (!timestamp || !sig) return false;

  // Reject old timestamps (replay attack protection)
  const now = Math.floor(Date.now() / 1000);
  if (Math.abs(now - parseInt(timestamp)) > 300) return false;

  // Compute expected signature
  const signedPayload = `${timestamp}.${payload}`;
  const expected = crypto
    .createHmac('sha256', secret)
    .update(signedPayload)
    .digest('hex');

  // Timing-safe comparison
  return crypto.timingSafeEqual(
    Buffer.from(expected),
    Buffer.from(sig)
  );
}
```

## Verification Response Types

### Success Response

When verification succeeds, you'll receive:

```json
{
  "valid": true,
  "onesubUserId": "uuid",
  "entitlements": {
    "planId": "monthly",
    "creditsRemaining": 500,
    "features": ["pro", "api_access"],
    "limits": { "api_calls_per_day": 10000 }
  },
  "verificationToken": "vt_new_xxx",
  "cacheUntil": 1703000400,
  "nextVerificationBefore": 1703000700
}
```

**Important:** The `verificationToken` changes with each verification (token rolling). Always update your stored token!

### Revoked/Invalid Response

When access is revoked or token is invalid:

```json
{
  "valid": false,
  "error": "ACCESS_REVOKED",
  "reason": "subscription_cancelled",
  "action": "terminate_session"
}
```

**Actions:**
- `terminate_session` - End the user's session immediately
- `reauthenticate` - Redirect user to re-authenticate via "Launch Tool"

## What 1sub Handles For You

You don't need to build:

- **User authentication** - 1sub verifies the user's identity
- **Payment processing** - 1sub handles all billing and payments
- **Subscription management** - Users manage subscriptions on 1sub
- **Refunds & disputes** - 1sub handles these automatically
- **Credit tracking** - 1sub maintains credit balances
- **Plan configuration** - Configure pricing in vendor dashboard

## Security Requirements

| Requirement | Why |
|------------|-----|
| Verify every 5 minutes | Ensures revocation is enforced |
| Store verificationToken securely | It grants access to user data |
| Use HTTPS for callback | Protects authorization code |
| Validate CSRF state | Prevents cross-site attacks |
| Handle webhooks idempotently | Webhooks may be retried |

## Complete Minimal Example

Here's a complete working implementation in ~80 lines:

```typescript
import express from 'express';
import session from 'express-session';
import axios from 'axios';
import crypto from 'crypto';

const app = express();
const API_KEY = process.env.ONESUB_API_KEY!;
const WEBHOOK_SECRET = process.env.ONESUB_WEBHOOK_SECRET!;

app.use(session({ secret: 'your-secret', resave: false, saveUninitialized: false }));
app.use(express.json());

// Step 1: Handle callback and exchange code
app.get('/auth/1sub/callback', async (req, res) => {
  try {
    const { code } = req.query;

    const { data } = await axios.post(
      'https://1sub.io/api/v1/authorize/exchange',
      { code, redirectUri: 'https://yourapp.com/auth/1sub/callback' },
      { headers: { Authorization: `Bearer ${API_KEY}` } }
    );

    if (!data.valid) return res.redirect('/error');

    req.session.user = {
      id: data.onesubUserId,
      token: data.verificationToken,
      entitlements: data.entitlements,
      verified: Date.now(),
    };
    res.redirect('/dashboard');
  } catch (error) {
    console.error(error);
    res.redirect('/error');
  }
});

// Step 2: Verification middleware (every 5 min)
async function verify(req, res, next) {
  if (!req.session.user) return res.redirect('/');

  const fiveMin = 5 * 60 * 1000;
  if (Date.now() - req.session.user.verified > fiveMin) {
    try {
      const { data } = await axios.post(
        'https://1sub.io/api/v1/verify',
        { verificationToken: req.session.user.token },
        { headers: { Authorization: `Bearer ${API_KEY}` } }
      );

      if (!data.valid) {
        req.session.destroy();
        return res.redirect('/?error=revoked');
      }

      req.session.user.token = data.verificationToken;
      req.session.user.entitlements = data.entitlements;
      req.session.user.verified = Date.now();
    } catch (error) {
      req.session.destroy();
      return res.redirect('/?error=verification_failed');
    }
  }
  next();
}

// Step 3: Webhook handler (immediate revocation)
app.post('/webhooks/1sub', express.raw({ type: 'application/json' }), (req, res) => {
  const signature = req.headers['1sub-signature'];
  const payload = req.body.toString();

  if (!verifySignature(payload, signature, WEBHOOK_SECRET)) {
    return res.status(401).end();
  }

  res.status(200).end();

  const event = JSON.parse(payload);
  if (event.type === 'subscription.canceled') {
    // Invalidate user sessions for this oneSubUserId
    sessionStore.invalidate(event.data.oneSubUserId);
  }
});

function verifySignature(payload, signature, secret) {
  const [t, sig] = signature.split(',').map(p => p.split('=')[1]);
  const expected = crypto.createHmac('sha256', secret).update(`${t}.${payload}`).digest('hex');
  return crypto.timingSafeEqual(Buffer.from(expected), Buffer.from(sig));
}

// Protected route
app.get('/dashboard', verify, (req, res) => {
  res.json({ credits: req.session.user.entitlements.creditsRemaining });
});

app.listen(3000);
```

## Testing Your Integration

1. **Purchase a subscription** to your tool on 1sub (use test mode)
2. **Click "Launch Tool"** - you should be redirected to your callback
3. **Check your session** - should have verification token
4. **Wait 5 minutes** - verify endpoint should be called
5. **Cancel subscription** - access should be revoked within 5 minutes

## Troubleshooting

### "Invalid authorization code"
- Codes expire in 60 seconds
- Codes are single-use
- Check `redirectUri` matches exactly

### "Token verification failed"
- Token may have expired (24h max)
- User access may have been revoked
- Check API key is correct

### Webhooks not received
- Check webhook URL is publicly accessible
- Verify webhook secret is configured
- Check firewall allows POST from 1sub IPs
