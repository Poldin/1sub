---
title: "API Reference"
description: "Complete reference for 1Sub Credits API"
---

# API Reference

The 1Sub API is only needed for **credit consumption**. Authentication uses Magic Login (zero API calls).

<Note>
If your tool doesn't use credits, you don't need to make any API calls. User authentication and subscription management are handled via Magic Login and webhooks.
</Note>

---

## Consume Credits

Deduct credits from a user's balance for tool usage.

<ParamField header="Authorization" type="string" required>
Bearer token with your tool API key (format: `Bearer sk-tool-xxxxx`)
</ParamField>

<ParamField body="user_id" type="string (UUID)" required>
The 1Sub user ID (`oneSubUserId`) - received via webhook or extracted from Magic Login
</ParamField>

<ParamField body="amount" type="number" required>
Number of credits to consume (positive integer, max 1,000,000)
</ParamField>

<ParamField body="reason" type="string" required>
Description of what credits were used for (1-500 characters)
</ParamField>

<ParamField body="idempotency_key" type="string" required>
Unique key to prevent duplicate charges (persisted for 24 hours)
</ParamField>

**Endpoint:** `POST /api/v1/credits/consume`

**Rate Limit:** 100 requests per minute

<RequestExample>
```bash cURL
curl -X POST 'https://1sub.io/api/v1/credits/consume' \
  -H 'Authorization: Bearer sk-tool-xxxxxxxxxxxxxxxxxxxxxxxx' \
  -H 'Content-Type: application/json' \
  -d '{
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "amount": 10,
    "reason": "Generated 1 AI image (1024x1024)",
    "idempotency_key": "img-gen-user123-1702345678"
  }'
```

```javascript Node.js
const response = await fetch('https://1sub.io/api/v1/credits/consume', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${process.env.ONESUB_API_KEY}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    user_id: oneSubUserId,
    amount: 10,
    reason: 'Generated 1 AI image',
    idempotency_key: `img-gen-${userId}-${Date.now()}`
  })
});

const result = await response.json();
console.log(`New balance: ${result.new_balance}`);
```

```python Python
import time

response = requests.post(
    'https://1sub.io/api/v1/credits/consume',
    json={
        'user_id': onesub_user_id,
        'amount': 10,
        'reason': 'Generated 1 AI image',
        'idempotency_key': f'img-gen-{user_id}-{int(time.time())}'
    },
    headers={
        'Authorization': f'Bearer {os.environ["ONESUB_API_KEY"]}',
        'Content-Type': 'application/json'
    }
)

result = response.json()
print(f"New balance: {result['new_balance']}")
```
</RequestExample>

<ResponseExample>
```json 200 OK - Success
{
  "success": true,
  "new_balance": 90,
  "transaction_id": "txn-abc123def456"
}
```

```json 402 Payment Required - Insufficient Credits
{
  "error": "Payment required",
  "message": "User does not have sufficient credits",
  "current_balance": 5,
  "required": 10,
  "shortfall": 5
}
```

```json 401 Unauthorized
{
  "error": "Invalid API key",
  "message": "The provided API key is invalid or does not exist"
}
```

```json 403 Forbidden - Access Revoked
{
  "error": "Forbidden",
  "message": "Access to this tool has been revoked",
  "reason": "subscription_cancelled",
  "action": "terminate_session"
}
```

```json 409 Conflict - Duplicate Request
{
  "success": true,
  "new_balance": 90,
  "transaction_id": "txn-abc123def456",
  "is_duplicate": true,
  "message": "This request has already been processed"
}
```
</ResponseExample>

### Response Fields

<ResponseField name="success" type="boolean" required>
Whether credits were successfully consumed
</ResponseField>

<ResponseField name="new_balance" type="number" required>
User's credit balance after consumption
</ResponseField>

<ResponseField name="transaction_id" type="string" required>
Unique ID for this transaction
</ResponseField>

<Tip>
Store the `transaction_id` for auditing and support purposes.
</Tip>

---

## Idempotency

The `idempotency_key` parameter prevents duplicate charges. If you send the same key twice within 24 hours, the second request returns the original result without consuming additional credits.

**Best practices:**
- Use meaningful, unique keys: `{action}-{user_id}-{timestamp}`
- Store keys alongside your records
- Retry failed requests with the same key

```typescript
// Good idempotency keys
const key1 = `image-gen-${userId}-${Date.now()}`;
const key2 = `analysis-${documentId}-${userId}`;
const key3 = `chat-${sessionId}-${messageCount}`;
```

---

## Error Handling

All endpoints return standard error responses:

```json
{
  "error": "Error type",
  "message": "Human-readable message",
  "details": {}
}
```

### Error Codes

| Status | Error | Meaning | Action |
|--------|-------|---------|--------|
| 400 | Bad Request | Invalid parameters | Check request body |
| 401 | Unauthorized | Invalid/missing API key | Verify API key |
| 402 | Payment Required | Insufficient credits | User needs to add credits |
| 403 | Forbidden | Access revoked or tool inactive | Terminate user session |
| 409 | Conflict | Duplicate request (idempotent) | Use returned result |
| 429 | Rate Limit Exceeded | Too many requests | Implement backoff |
| 500 | Internal Server Error | Server error | Retry with backoff |

<Warning>
Always implement proper error handling and retry logic, especially for 429 and 500 errors.
</Warning>

---

## Rate Limit Headers

All authenticated endpoints return rate limit information:

```http
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 2025-12-01T12:35:00Z
```

Use these headers to track your usage and avoid hitting rate limits.

---

## Getting User ID

The `user_id` parameter is the 1Sub user ID (`oneSubUserId`). You get this from:

1. **Magic Login URL** - Passed as the `user` query parameter when users click "Launch Magic Login"
2. **Webhooks** - Included in the `oneSubUserId` field of webhook payloads

```typescript
// From Magic Login
app.get('/auth/magic', (req, res) => {
  const oneSubUserId = req.query.user;
  // Store this for credit consumption
});

// From webhooks
app.post('/webhooks/1sub', (req, res) => {
  const { oneSubUserId } = req.body.data;
  // Store this for credit consumption
});
```

---

## Handling Revocation

When you receive a `403 Forbidden` with `action: "terminate_session"`, the user's access has been revoked. You should:

1. **Terminate their session** immediately
2. **Stop consuming credits** for this user
3. **Clear cached data**
4. **Show an "access ended" message**

This happens when:
- User cancels subscription
- Payment fails
- Admin revokes access
- You receive a `security.force_logout` webhook

<Warning>
**Critical:** When you receive a 403 with revocation, do NOT retry the request. Terminate the user's session immediately.
</Warning>

<CardGroup cols={2}>
<Card title="Webhook Events" icon="webhook" href="/docs/webhooks/events">
  Handle subscription and security events
</Card>

<Card title="Magic Login" icon="sparkles" href="/docs/api/magic-login">
  Zero-API-call authentication
</Card>
</CardGroup>
