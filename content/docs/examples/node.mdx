---
title: "Node.js Example"
description: "Complete Node.js / Express integration example"
---

# Node.js Example

A complete working example using Node.js and Express.

## Installation

```bash
npm install express express-session
```

## Environment Variables

```bash
# .env
ONESUB_API_KEY=sk-tool-xxxxxxxxxxxxxxxxxxxxxxxx
ONESUB_WEBHOOK_SECRET=whsec-xxxxxxxxxxxxxxxxxxxxxxxx
SESSION_SECRET=your-session-secret
```

## Complete Example

```typescript
import express from 'express';
import session from 'express-session';
import crypto from 'crypto';

const app = express();
const API_KEY = process.env.ONESUB_API_KEY;
const WEBHOOK_SECRET = process.env.ONESUB_WEBHOOK_SECRET;

app.use(session({
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
}));

// ============================================
// Step 1: Callback endpoint
// ============================================
app.get('/auth/callback', async (req, res) => {
  const { code } = req.query;

  const response = await fetch('https://1sub.io/api/v1/authorize/exchange', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ code }),
  });

  const data = await response.json();

  if (!data.valid) {
    return res.redirect('/?error=auth_failed');
  }

  // Create session
  req.session.userId = data.onesubUserId;
  req.session.token = data.verificationToken;
  req.session.entitlements = data.entitlements;
  req.session.lastCheck = Date.now();

  res.redirect('/dashboard');
});

// ============================================
// Step 2: Access check middleware
// ============================================
async function checkAccess(req, res, next) {
  const { token, lastCheck } = req.session;

  if (!token) {
    return res.status(401).json({ error: 'Not authenticated' });
  }

  // Check every 5 minutes
  const fiveMinutes = 5 * 60 * 1000;
  if (Date.now() - lastCheck > fiveMinutes) {
    const response = await fetch('https://1sub.io/api/v1/verify', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ verificationToken: token }),
    });

    const data = await response.json();

    if (!data.valid) {
      req.session.destroy(() => {});
      return res.status(403).json({ error: 'Access revoked' });
    }

    // Update session with new token
    req.session.token = data.verificationToken;
    req.session.entitlements = data.entitlements;
    req.session.lastCheck = Date.now();
  }

  next();
}

// ============================================
// Step 3: Webhook handler
// ============================================
app.post('/webhooks/1sub', express.json(), (req, res) => {
  const event = req.body;

  switch (event.type) {
    case 'subscription.canceled':
      // Invalidate user's sessions
      console.log('Subscription canceled:', event.data.oneSubUserId);
      break;
  }

  res.status(200).send('OK');
});

// ============================================
// Protected routes
// ============================================
app.get('/dashboard', checkAccess, (req, res) => {
  res.json({
    message: 'Welcome!',
    entitlements: req.session.entitlements,
  });
});

app.post('/api/feature', checkAccess, (req, res) => {
  // User has valid subscription
  res.json({ result: 'Premium content!' });
});

// ============================================
// Start server
// ============================================
app.listen(3000, () => {
  console.log('Server running on port 3000');
});
```

## Testing

```bash
# 1. Click "Launch Tool" on your 1Sub tool page
# 2. You'll be redirected to /auth/callback

# Test protected route
curl http://localhost:3000/dashboard \
  -H 'Cookie: connect.sid=YOUR_SESSION'

# Test webhook
curl -X POST http://localhost:3000/webhooks/1sub \
  -H 'Content-Type: application/json' \
  -d '{"type":"subscription.canceled","data":{"oneSubUserId":"test"}}'
```

## Production Notes

- Use Redis for session storage
- Add signature verification to webhooks
- Implement proper error handling
- Add logging and monitoring
