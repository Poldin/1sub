---
title: "Python Example"
description: "Complete Python / Flask integration example"
---

# Python Example

A complete working example using Python and Flask.

## Installation

```bash
pip install flask requests python-dotenv
```

## Environment Variables

```bash
# .env
ONESUB_API_KEY=sk-tool-xxxxxxxxxxxxxxxxxxxxxxxx
ONESUB_WEBHOOK_SECRET=whsec-xxxxxxxxxxxxxxxxxxxxxxxx
SESSION_SECRET=your-session-secret
```

## Complete Example

```python
import os
import time
import requests
from flask import Flask, request, jsonify, session, redirect

app = Flask(__name__)
app.secret_key = os.environ['SESSION_SECRET']

API_KEY = os.environ['ONESUB_API_KEY']
BASE_URL = 'https://1sub.io/api/v1'

# ============================================
# Step 1: Callback endpoint
# ============================================
@app.route('/auth/callback')
def auth_callback():
    code = request.args.get('code')
    if not code:
        return redirect('/?error=missing_code')

    response = requests.post(
        f'{BASE_URL}/authorize/exchange',
        json={'code': code},
        headers={
            'Authorization': f'Bearer {API_KEY}',
            'Content-Type': 'application/json'
        }
    )

    data = response.json()
    if not data.get('valid'):
        return redirect('/?error=auth_failed')

    # Create session
    session['user_id'] = data['onesubUserId']
    session['token'] = data['verificationToken']
    session['entitlements'] = data['entitlements']
    session['last_check'] = time.time()

    return redirect('/dashboard')

# ============================================
# Step 2: Access check decorator
# ============================================
def require_subscription(f):
    from functools import wraps

    @wraps(f)
    def decorated(*args, **kwargs):
        token = session.get('token')
        last_check = session.get('last_check', 0)

        if not token:
            return jsonify({'error': 'Not authenticated'}), 401

        # Check every 5 minutes
        five_minutes = 5 * 60
        if time.time() - last_check > five_minutes:
            response = requests.post(
                f'{BASE_URL}/verify',
                json={'verificationToken': token},
                headers={
                    'Authorization': f'Bearer {API_KEY}',
                    'Content-Type': 'application/json'
                }
            )

            data = response.json()
            if not data.get('valid'):
                session.clear()
                return jsonify({'error': 'Access revoked'}), 403

            # Update session with new token
            session['token'] = data['verificationToken']
            session['entitlements'] = data['entitlements']
            session['last_check'] = time.time()

        return f(*args, **kwargs)
    return decorated

# ============================================
# Step 3: Webhook handler
# ============================================
@app.route('/webhooks/1sub', methods=['POST'])
def webhook():
    event = request.get_json()

    if event['type'] == 'subscription.canceled':
        print(f"Subscription canceled: {event['data']['oneSubUserId']}")
        # Invalidate user's sessions

    return jsonify({'received': True})

# ============================================
# Protected routes
# ============================================
@app.route('/dashboard')
@require_subscription
def dashboard():
    return jsonify({
        'message': 'Welcome!',
        'entitlements': session.get('entitlements')
    })

@app.route('/api/feature', methods=['POST'])
@require_subscription
def feature():
    return jsonify({'result': 'Premium content!'})

if __name__ == '__main__':
    app.run(port=3000)
```

## Testing

```bash
# 1. Click "Launch Tool" on your 1Sub tool page
# 2. You'll be redirected to /auth/callback

# Test protected route
curl http://localhost:3000/dashboard \
  -H 'Cookie: session=YOUR_SESSION'

# Test webhook
curl -X POST http://localhost:3000/webhooks/1sub \
  -H 'Content-Type: application/json' \
  -d '{"type":"subscription.canceled","data":{"oneSubUserId":"test"}}'
```

## Production Notes

- Use Redis for session storage (Flask-Session)
- Add signature verification to webhooks
- Implement proper error handling
- Add logging and monitoring
